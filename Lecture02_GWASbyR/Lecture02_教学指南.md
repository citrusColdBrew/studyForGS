# Lecture02 教学指南：GWAS入门理论与实践

## 教学目标与学习路径

### 面向对象
- 计算机专业学生，具备基础编程能力
- 对生物信息学和基因组学感兴趣的初学者
- 需要从零开始建立生物学和统计学基础

### 课前准备知识
1. **数学基础**：线性代数、概率论、统计学基础
2. **编程基础**：R语言基本语法
3. **生物学概念**：DNA、基因、染色体的基本概念

---

## 生物学基础知识讲解

### 1. 遗传学基础概念

#### 1.1 基因型与表型
- **基因型（Genotype）**：个体的遗传组成，即DNA序列
- **表型（Phenotype）**：可观察的性状，如身高、体重、疾病状态
- **关键理解**：基因型决定表型，但环境因素也有影响

#### 1.2 SNP（单核苷酸多态性）
```
参考序列：...AAGCCTA...
变异序列：...AAGCTTA...（C→T变异）
```
- SNP是人类基因组中最常见的遗传变异类型
- 平均每300bp就有一个SNP
- 大多数SNP不影响表型，但少数与疾病或性状相关

#### 1.3 等位基因频率
- **等位基因**：基因的不同形式（如A和a）
- **编码方式**：
  - 0 = AA（参考纯合子）
  - 1 = Aa（杂合子）
  - 2 = aa（变异纯合子）

### 2. GWAS的生物学原理

#### 2.1 连锁不平衡（Linkage Disequilibrium, LD）
- **定义**：基因组上相近位点的基因型不独立
- **GWAS意义**：即使标记SNP本身不是致病变异，但如果与真正的致病变异存在连锁不平衡，仍能检测到关联信号

#### 2.2 遗传力（Heritability）
- **定义**：遗传因素对表型变异的贡献比例
- **公式**：h² = V_G / V_P（遗传方差/总表型方差）
- **实例**：身高的遗传力约为0.8，说明80%的身高差异由遗传因素决定

---

## 统计学方法详解

### 1. 相关性分析的数学原理

#### 1.1 Pearson相关系数
```
r = Σ[(Xi - X̄)(Yi - Ȳ)] / √[Σ(Xi - X̄)² × Σ(Yi - Ȳ)²]
```
- **取值范围**：[-1, 1]
- **解释**：0.7-1.0强相关，0.3-0.7中等相关，0-0.3弱相关

#### 1.2 显著性检验
```
t = r × √[(n-2)/(1-r²)]
```
- **原假设**：SNP与表型无关联（r=0）
- **备择假设**：存在关联（r≠0）
- **p值计算**：基于t分布（自由度=n-2）

### 2. 线性回归模型

#### 2.1 简单线性回归
```
Y = β₀ + β₁X + ε
```
- Y：表型值
- X：基因型（0/1/2）
- β₁：基因型效应
- ε：随机误差

#### 2.2 多重线性回归（GLM）
```
Y = β₀ + β₁PC₁ + β₂PC₂ + ... + βₖPCₖ + βₛSNP + ε
```
- PC₁, PC₂, ...：主成分（控制群体结构）
- SNP：待检验的基因型
- **优势**：能够控制混杂因素

### 3. 主成分分析（PCA）

#### 3.1 数学原理
- **目标**：寻找能最大化方差的线性组合
- **第一主成分**：解释最大方差的方向
- **在GWAS中的应用**：前几个主成分通常反映群体结构

#### 3.2 群体结构问题
```
真实情况：亚群1（基因型A多，表型值高）
          亚群2（基因型B多，表型值低）
错误结论：基因型与表型相关
正确解释：群体分层导致的假关联
```

---

## 代码实现详解

### 1. 数据结构理解

#### 1.1 基因型矩阵（X）
```
       SNP1  SNP2  SNP3  ...
个体1    0     1     2   ...
个体2    1     0     1   ...
个体3    2     2     0   ...
...
```

#### 1.2 表型向量（y）
```
个体1: 165.2
个体2: 170.5
个体3: 158.9
...
```

### 2. 关键函数解析

#### 2.1 cor()函数
```r
r <- cor(y, X)  # 计算y与X每一列的相关系数
# 返回：长度等于SNP数量的向量
```

#### 2.2 矩阵运算
```r
# 正规方程求解：β = (X'X)⁻¹X'y
LHS <- t(X) %*% X      # X转置乘以X
C <- solve(LHS)         # 求逆矩阵
RHS <- t(X) %*% y      # X转置乘以y
b <- C %*% RHS         # 最终系数
```

### 3. 循环优化策略

#### 3.1 质量控制
```r
if (max(x) == min(x)) {
    p <- 1  # 单态SNP直接设p值为1
}
```
- **原因**：所有个体基因型相同的SNP无变异，无法进行统计检验

#### 3.2 批量处理
- 使用for循环逐个分析每个SNP
- 每次循环构建新的设计矩阵
- 存储每个SNP的p值用于后续分析

---

## 结果解读指南

### 1. 曼哈顿图（Manhattan Plot）

#### 1.1 基本解读
- **x轴**：基因组位置（按染色体排列）
- **y轴**：-log₁₀(p值)，值越大越显著
- **显著性阈值**：通常为5×10⁻⁸（-log₁₀ ≈ 7.3）

#### 1.2 模式识别
- **尖峰**：可能的关联信号
- **平台**：背景噪音
- **多个染色体有信号**：可能存在多个QTL

### 2. QQ图（Quantile-Quantile Plot）

#### 2.1 理想情况
- 点落在y=x直线上
- 表明没有系统性偏差

#### 2.2 问题诊断
- **整体上偏**：群体结构、亲缘关系等系统偏差
- **尾部上翘**：真实关联信号
- **基因组膨胀因子λ**：λ>1.05提示可能存在偏差

### 3. 箱线图分析

#### 3.1 基因型效应
```
基因型0(AA): 表型均值 ± 标准差
基因型1(Aa): 表型均值 ± 标准差
基因型2(aa): 表型均值 ± 标准差
```

#### 3.2 遗传模式
- **加性效应**：0<1<2（线性递增）
- **显性效应**：0<1≈2
- **隐性效应**：0≈1<2

---

## 常见问题与解答

### 1. 生物学概念
**Q**: 为什么要使用0/1/2编码？
**A**: 这种编码直接反映变异等位基因的拷贝数，便于进行加性效应分析。

**Q**: 遗传力和相关性有什么区别？
**A**: 遗传力是群体概念，衡量遗传因素的整体贡献；相关性是个体概念，衡量单个SNP的效应。

### 2. 统计学方法
**Q**: 为什么需要多重检验校正？
**A**: GWAS通常检验数十万到数百万个SNP，需要控制假阳性率。

**Q**: 主成分数量如何选择？
**A**: 通常选择前3-10个主成分，具体数量取决于群体结构复杂程度。

### 3. 技术实现
**Q**: 为什么要设置随机种子？
**A**: 确保结果可重现，便于验证和调试。

**Q**: 矩阵运算为什么比循环快？
**A**: 矩阵运算利用了优化的线性代数库，计算效率更高。

---

## 扩展学习资源

### 1. 理论深化
- 《Statistical Methods in Genetic Epidemiology》
- 《An Introduction to Genetic Analysis》
- Nature Genetics期刊GWAS方法学文章

### 2. 实践工具
- **PLINK**：命令行GWAS分析工具
- **GAPIT**：R语言GWAS分析包
- **GCTA**：复杂性状遗传分析工具

### 3. 数据资源
- **1000 Genomes Project**：人类基因组变异数据
- **Arabidopsis 1001 Genomes**：植物GWAS数据
- **Drosophila Genetic Reference Panel**：果蝇遗传资源

---

## 作业和思考题

### 1. 概念理解
1. 解释连锁不平衡在GWAS中的作用
2. 比较相关性分析和线性回归的优缺点
3. 说明群体结构如何影响GWAS结果

### 2. 数据分析
1. 修改代码，比较不同主成分数量对结果的影响
2. 分析不同遗传力设置下的检验功效变化
3. 计算并解释基因组膨胀因子

### 3. 方法扩展
1. 实现logistic回归用于二分类性状分析
2. 添加性别、年龄等协变量到分析模型中
3. 编写函数计算连锁不平衡指标

这个教学体系从生物学基础开始，逐步深入到统计方法和代码实现，确保计算机专业学生能够全面理解GWAS的原理和实践。